---
import 'swiper/css';
import 'swiper/css/pagination';
import { products } from '~/data/productsData';

const featuredProducts = products
  .filter((product) => product.feature === true)
  .map((product, index) => ({
    id: `product-${index}`,
    productId: product.id,
    image: product.image,
    title: product.title,
    subtitle: product.subtitle,
    description: product.description,
    brandId: product.brand.id,
    viewBtn: `View More From ${product.brand.id.charAt(0).toUpperCase() + product.brand.id.slice(1)}`,
  }));
---

<div class='max-w-5xl mx-auto md:px-0 px-6' id='productsCarouselRoot'>
  <div class='swiper'>
    <div class='swiper-wrapper'>
      {
        featuredProducts.map((product, index) => (
          <div class='swiper-slide w-full md:h-[450px] h-[953px]' data-slide-index={index}>
            <div class='flex items-center md:flex-row flex-col gap-[28px] md:gap-[64px]'>
              <div class='flex-shrink-0'>
                <img
                  src={product.image}
                  class='w-[299px] h-[400px] object-cover select-none'
                  alt={product.title}
                  loading='lazy'
                  draggable='false'
                />
              </div>

              <div class='flex-1'>
                <h2 class='text-[24px] font-bold text-gradient-tertiary'>{product.title}</h2>
                <p class='text-[18px] mt-[16px]'>{product.subtitle}</p>
                <p class='text-[20px] pt-[24px] line-clamp-3'>{product.description}</p>

                <div class='flex md:flex-row flex-col items-center gap-[24px] md:gap-4 mt-[32px]'>
                  <a
                    href='/get-a-quote'
                    class='bg-gradient-primary w-fit py-[16px] px-[32px] shadow-primary rounded-[32px] text-white font-bold text-[16px] hover:shadow-lg transition-shadow'
                  >
                    Get a Quote
                  </a>
                  <a
                    href={`/brand/${product.brandId}/${product.productId}`}
                    class='py-[16px] px-[32px] w-fit border-2 border-[#75317A] rounded-[32px] text-[16px] text-[#75317A] font-bold hover:bg-[#75317A] hover:text-white transition-colors'
                  >
                    {product.viewBtn}
                  </a>
                </div>
              </div>
            </div>
          </div>
        ))
      }
    </div>
    <div class='siwper-wrapper mt-[80px] md:mt-0'>
      <div class='swiper-pagination'></div>
    </div>
  </div>
</div>

<style>
  :global(.products-carousel .swiper-pagination-bullet) {
    background-color: #808080;
    opacity: 0.5;
    width: 12px;
    height: 12px;
  }

  :global(.products-carousel .swiper-pagination-bullet-active) {
    background-color: #808080;
    opacity: 0.75;
    width: 48px;
    border-radius: 6px;
  }
</style>

<script>
  import Swiper from 'swiper';
  import { Autoplay, Pagination } from 'swiper/modules';

  function initializeProductsCarousel() {
    const root = document.getElementById('productsCarouselRoot');
    if (!(root instanceof HTMLElement)) return;

    root.classList.add('products-carousel');

    const swiperElement = root.querySelector('.swiper');
    if (!(swiperElement instanceof HTMLElement)) return;

    new Swiper(swiperElement, {
      modules: [Autoplay, Pagination],
      autoplay: {
        delay: 8000,
        disableOnInteraction: false,
      },
      pagination: {
        el: swiperElement.querySelector('.swiper-pagination') as HTMLElement,
        clickable: true,
        dynamicBullets: false,
      },
      loop: true,
      observer: true,
      observeParents: true,
      touchRatio: 1,
      touchAngle: 45,
      keyboard: {
        enabled: true,
      },
      on: {
        slideChange() {
          try {
            if (this.pagination && typeof this.pagination.update === 'function') {
              this.pagination.update();
            }
          } catch {
            // swallow errors silently â€” pagination update is best-effort
          }
        },
      },
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeProductsCarousel);
  } else {
    initializeProductsCarousel();
  }

  document.addEventListener('astro:page-load', initializeProductsCarousel);
</script>
